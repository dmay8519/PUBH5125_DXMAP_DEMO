---
title: PUBH5125 Environmental and Social Epidemiology
  <br>
  <p style="color:#990000; font-size:44pt; font-weight:bolder;">Environmental Epidemiology Study Designs:<br>Disease Mapping Demonstration</p></br>
  # <p style="font-size:38pt">&nbsp;</p>
author: <p style="font-size:18pt; font-weight:normal">30 April 2025</p>
  <p>Dr Darren Mayne</p>
  <p style="font-size:18pt; font-weight:normal;">Public Health Epidemiologist<br>Illawarra Shoalhaven Local Health District<br>
  <br>
  Adjunct Senior Lecturer<br>Faculty of Medicine, School of Public Health</p></span>
date: Full RStudio project code available from <a href="https://github.com/dmay8519/PUBH5125_DXMAP_DEMO" target="_blank" rel="noopener noreferrer">https://github.com/dmay8519/PUBH5125_DXMAP_DEMO</a>.<br>
  Standalone R markdown (Rmd) code can be downloded using the <b>Code</b> button in the top right hand corner and selecting <b>Download Rmd</b>.
  <p><a href="https://github.com/dmay8519/PUBH5125_DXMAP_2025" target="_blank" rel="noopener noreferrer">Environmental Epidemiology Study Designs --- Disease Mapping Demonstration</a> (PUBH5125_DXMAP_DEMO) by <a href="https://www.linkedin.com/in/themaynestory" 
  target="_blank" rel="noopener noreferrer">Darren Mayne</a> is licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1" target="_blank" rel="noopener noreferrer">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 
  International</a> <img src="https://mirrors.creativecommons.org/presskit/buttons/88x31/png/by-nc-sa.png" alt="BY NC SA" height="20px" hspace="1px"></p><br>
output:
    html_document:
      # css: assets/rany_style.css
      df_print: paged
      theme: readable
      highlight: tango
      toc: yes
      toc_float:
        collapsed: TRUE
      number_sections: FALSE
      code_folding: show
      code_download: TRUE
---

<!-- Add inline style sheet -->

<!-- ```{css, echo = FALSE} -->

```{=html}
<style = text/css>

.main-container {
  max-width: 100% !important;
  margin: auto;
}

body {
  font-family: "Public Sans Light";
  font-size: 18pt;
}

h1 {
    font-family: "Public Sans Light";
    font-size: 18pt;
    font-weight: bold;
    color: #467d62;
}

h1.title {
    font-family: "Public Sans Light";
    font-size: 38pt;
    font-weight: bold;
    text-align:center;
    color: black;
}

h2 {
    font-family: "Public Sans Light";
    font-size: 28pt;
    font-weight: bold;
    color: #990000;
}

/*

h3 {
    font-family: "Public Sans Light";
    font-size: 38pt;
    font-weight: bold;
    color: black;
}

*/

h3 {
    font-family: "Public Sans Light";
    font-size: 22pt;
    font-weight: bold;
    color: #FB5151;
}

.author {
    font-family: "Public Sans Light";
    font-size: 28pt;
    font-weight: bold;
    text-align: center;
    color: black;
}

.date {
    font-family: "Public Sans Light";
    font-size: 14pt;
    font-weight: normal;
    text-align: left;
    color: black;
}

.code-folding-btn {
  font-family: "Public Sans Light";
  font-size: 10pt;
  <!-- display: none; -->
}

/* Set global maximum height for all chunks */

pre {
  background-color: white;
  max-height: 100%;
  overflow-y: auto;
}

/* Limit height of <PRE> blocks to 100px */

pre[class] {
  background-color: white;
  max-height: 100%;
}

/* Limits chunk codes to 100px */

.scroll-100 {
  max-height: 100px;
  overflow-y: auto;
}

/* Style class selector for <pre></pre> tags - source/output containers */ 

.textPre {
  font-family: mono;
  font-size: 10pt;
  background-color: white;
}

/* Hack required to get Pandoc to render line numbers */ 

.sourceCode {
  overflow: visible;
}

/* Adjust TOC width and font size */

div.tocify {
  font-size: 12pt;
  max-width: 100%;
}

/* Implement hanging paragraph indentation in reference list*/

.nlm-reference {
  padding-left: 30px;
  text-indent: -30px;
}

</style>
```

<!-- ``` -->

## Background

<div style="line-height:2.0;">
* This session will demonstrate fitting the Besag, York, and Mollié (1991) conditional autoregressive (CAR) model for disease mapping and ecological regression applications involving areal data.

* We will use a classic data set first reported by Clayton and Kaldor (1987) that describes the incidence of male lip cancer within Scottish administration districts from 1975 to 1980.

* The data set was subsequently expanded to include the number of male population-years at-risk (Cressie, 1993) and the expected number of lip cancer cases and percentage of males employed in agriculture, fishing and forestry (AFF) (Stern & Cressie, 1999) in each district.

* The map of Scottish administrative districts is a post-processed version of the Scotland.map S-Plus boundary file that was included in WinBUGS 1.4.3, a state-of-the-art 32-bit program for Bayesian inference when released on 6^th^ August 2007 --- now, not so much...

* All data are available in a single ZIP archive available on the [GeoDa Centre GuitHub repository](https://geodacenter.github.io/data-and-lab/scotlip/) and are described in Table 1 (columns 1 nd 2), along with the subset of variables used for this demonstration (columns 3 and 4)
</div>

Table 1: Data summary for Scottish lip cancer data set available from GeoDa Centre GitHub repository

<table class=" lightable-classic" style="width=1440px !important; table-layout:fixed; font-size: 14pt; font-family: Public Sans Light; margin-left: auto; margin-right: auto;">
 <thead style="border-top:1px solid black; border-bottom:1px solid black; padding:3px;">
  <tr>
   <th style="text-align:left; width: 216px;"> GeoDa variable </th>
   <th style="text-align:left; width: 504px;"> GeoDa description </th>
   <th style="text-align:left; width: 216px;"> PUBH5125 variable </th>
   <th style="text-align:left; width: 504px;"> PUBH5125 description </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;width: 15%; "> CODENO </td>
   <td style="text-align:left;width: 35%; "> Code converted to numeric (drop w prefix) </td>
   <td style="text-align:left;width: 15%; text-decoration: line-through; "> CODENO </td>
   <td style="text-align:left;width: 35%; text-decoration: line-through; "> Code converted to numeric (drop w prefix) </td>
  </tr>
  <tr>
   <td style="text-align:left;width: 15%; "> AREA </td>
   <td style="text-align:left;width: 35%; "> District polygon area </td>
   <td style="text-align:left;width: 15%; text-decoration: line-through;"> AREA </td>
   <td style="text-align:left;width: 35%; text-decoration: line-through;"> District polygon area </td>
  </tr>
  <tr>
   <td style="text-align:left;width: 15%; "> PERIMETER </td>
   <td style="text-align:left;width: 35%; "> District polygon perimeter </td>
   <td style="text-align:left;width: 15%; text-decoration: line-through;"> PERIMETER </td>
   <td style="text-align:left;width: 35%; text-decoration: line-through;"> District polygon perimeter </td>
  </tr>
  <tr>
   <td style="text-align:left;width: 15%; "> RECORD_ID </td>
   <td style="text-align:left;width: 35%; "> Unique ID </td>
   <td style="text-align:left;width: 15%; text-decoration: line-through; "> RECORD_ID </td>
   <td style="text-align:left;width: 35%; text-decoration: line-through; "> Unique ID </td>
  </tr>
  <tr>
   <td style="text-align:left;width: 15%; "> DISTRICT </td>
   <td style="text-align:left;width: 35%; "> District number 1-56 </td>
   <td style="text-align:left;width: 15%; "> dist_code </td>
   <td style="text-align:left;width: 35%; "> District number 1-56 </td>
  </tr>
  <tr>
   <td style="text-align:left;width: 15%; "> NAME </td>
   <td style="text-align:left;width: 35%; "> Name of districts from Cressie (1993) </td>
   <td style="text-align:left;width: 15%; "> dist_name </td>
   <td style="text-align:left;width: 35%; "> Name of districts from Cressie (1993) </td>
  </tr>
  <tr>
   <td style="text-align:left;width: 15%; "> CODE </td>
   <td style="text-align:left;width: 35%; "> District code from WinBugs </td>
   <td style="text-align:left;width: 15%; text-decoration: line-through; "> CODE </td>
   <td style="text-align:left;width: 35%; text-decoration: line-through; "> District code from WinBugs </td>
  </tr>
  <tr>
   <td style="text-align:left;width: 15%; "> CANCER </td>
   <td style="text-align:left;width: 35%; "> Lip cancer cases from Cressie (1993) </td>
   <td style="text-align:left;width: 15%; "> obs_ca </td>
   <td style="text-align:left;width: 35%; "> Lip cancer cases from Cressie (1993) </td>
  </tr>
  <tr>
   <td style="text-align:left;width: 15%; "> POP </td>
   <td style="text-align:left;width: 35%; "> Population years at risk from Cressie (1993) </td>
   <td style="text-align:left;width: 15%; "> dist_popn </td>
   <td style="text-align:left;width: 35%; "> Population years at risk from Cressie (1993) </td>
  </tr>
  <tr>
   <td style="text-align:left;width: 15%; "> CEXP </td>
   <td style="text-align:left;width: 35%; "> Expected cases from Lawson et al. (1999) </td>
   <td style="text-align:left;width: 15%; "> exp_ca </td>
   <td style="text-align:left;width: 35%; "> Expected cases from Stern &amp; Cressie (1999) </td>
  </tr>
  <tr style="border-bottom:1px solid black;">
   <td style="text-align:left;width: 15%; "> AFF </td>
   <td style="text-align:left;width: 35%; "> Outdoor industry from Lawson et al. (1999) </td>
   <td style="text-align:left;width: 15%; "> pct_aff </td>
   <td style="text-align:left;width: 35%; "> Outdoor industry from Stern &amp; Cressie (1999) </td>
  </tr>
</tbody>
</table>

## Aims of this session

<div style="line-height:2.2;">
1.  Download spatial boundaries and observed and expected cases of incident male lip cancer in Scottish districts from 1975–1980\
2.  Calculate and map the standardised incidence ratios (SIR) and their precision from the raw data\
3.  Create a queen adjacency matrix that identifies the neighbours for each Scottish district sharing a common boundary (edge) or point (vertex)\
4.  Fit a Besag, York and Mollié (BYM) conditional autoregressive (CAR) model to produce a smoothed disease map of lip cancer risk in Scotland over the study period\
    4.1 Calculate and map residual risk estimated by $e^{s_i + u_i}$\
    4.2 Decompose and map residual risk due to spatially structured $(e^{s_i})$ and unstructured $(e^{u_i})$ effects\
    4.3 Estimate proportion of residual risk in male lip cancer incidence due to spatial effects $\rho = \sigma^{2}_{s} / (\sigma^{2}_{s} + \sigma^{2}_{u})$\
    4.4 Calculate posterior probability for increased residual risk of male lip cancer incidence for each district
5.  Fit a BYM ecological CAR model to obtain an effect estimate for the association between lip cancer incidence and the percentage of male population engaged in agriculture, fishing and forestry (AFF)\
    5.1 Calculate effect estimate and 95% credible interval (CrI) for AFF exposure covariate\
    5.1 Calculate and map residual risk estimated by $e^{s_i + u_i}$\
    5.2 Decompose and map residual risk due to spatially structured and unstructured effects\
    5.3 Evaluate change in $(\rho)$ after adjusting for the percentage of male population in AFF\
    5.4 Calculate (posterior) probability of increased lip cancer risk for each district after adjusting for AFF\
6.  Compare changes in residual variance due to spatially structured and unstructured factors from 4 to 5
</div>

## Preliminaries

```{r options, include = FALSE}

knitr::opts_chunk$set(echo = TRUE)

knitr::opts_chunk$append(attr.source = '.numberLines',
                         class.source = ".textPre",
                         class.output = ".textPre",
                         attr.output = '.numberLines')

base::options(width = 170)


```

### Required packages

These are the packages that need to be installed and attached to complete the analysis.

```{r required}

{ # Check for and install pacman package if missing
  
  if(base::require(pacman, quietly = TRUE) == FALSE){install.packages("pacman")}
  
  # list required packages
  
  reqPackages <- c("tidyverse",      # An opinionated collection of R packages designed for data science
                   "CARBayes",       # Spatial Generalised Linear Mixed Models for Areal Unit Data
                   "coda",           # A package for Output Analysis and Diagnostics for MCMC
                   "epitools",       # A package for epidemiological analysis
                   "ggmcmc",         # MCMC diagnostics with ggplot
                   "ggpubr",         # A package for producing publication-ready plots 
                   "ggrepel",        # A package for position non-overlapping text labels with 'ggplot2'
                   "GGally",         # A package to do pairplots
                   "knitr",          # A general-purpose tool for dynamic report generation in R
                   "nimble",         # A package for performing MCMC in R
                   "patchwork",      # A package to combine plots
                   "rmarkdown",      # A package for creating dynamic documents for R
                   "RColorBrewer",   # A package of colour palettes
                   "scales",         # Scale functions for visualization
                   "sf",             # Simple features for R
                   "spdep")          # A package to calculate neighbors)
  
  # Load (and install if missing) other required packages
  
  pacman::p_load(char = reqPackages, install = TRUE)
  
  # Check required packages are loaded
  
  pacman::p_loaded(char = reqPackages)
  
}

```

### R environment

This output shows the `R` environment of the analysis; it includes dependencies loaded / attached by packages above.

```{r environ, class.output=".textPre .scroll-100"}

# Get session information

utils::sessionInfo()

```

## Data

In this section we extract, transform and load (ETL) the lip cancer data. This can be done manually, but the folded code chunk show how it can be done entirely withi `R`.

### Download data

The following output section shows all the files contained in the GeoDa Center ZIP file we downloaded using the folded **Code** chunk. We will use the `scotlip/scotlip.gpkg` GeoPackage data file with record index 79 at row 40 for our analysis. 

```{r download-data}

# Download Scottish lip cancer data --------------------------------------------

# Available from the the GeoDa Center as a zipped archive from:
# https://geodacenter.github.io/data-and-lab/scotlip/ but can be downloaded
# directly within R

# Download ZIP file to temp directory

data.url <- "https://geodacenter.github.io/data-and-lab/data/scotlip.zip"

utils::download.file(data.url,
                     base::file.path(base::tempdir(), "scotlip.zip"),
                     mode = "wb")

# View the contents of the zip file

utils::unzip(zipfile = base::file.path(base::tempdir(), "scotlip.zip"), list = TRUE) %>%
              base::as.data.frame() %>%
              arrange(Name) %>%
  dplyr::pull(Name)

```

### Extract data

A GeoPackage is an open-source, standards-based and platform independent file format for storing both spatial and attribute data in a single, portable file. In this code chunk, we extract the GeoPackage and then query it to identify the correct correct data layer to use.  

```{r extract-data}

## Extract the scotlip.gpkg geopackage data file (row 79) ----------------------

# See https://en.wikipedia.org/wiki/GeoPackage for a description of the 
# geopackage data format. 

# Extract the scotlip.gpkg geopackage from the ZIP file

utils::unzip(zipfile = base::file.path(base::tempdir(), "scotlip.zip"),
             files = "scotlip/scotlip.gpkg",
             exdir = base::tempdir(),
             junkpaths = TRUE) # Only use the file name of the stored file path when extracting

# List GeoPack layers

base::cat("List GeoPackage layers:",
          "\n\n",
          base::as.character(base::data.frame(layers = sf::st_layers(base::file.path(base::tempdir(), "scotlip.gpkg"))$name)))

```

### Load data

As the GeoPackage contains a single layer (scotlip), we read this into `R`, only to be disappointed that the wrong coordinate reference system (WGS 80) has been assigned to the spatial data. The correct projected coordinate reference system for these data are [OSGB36 / British National Grid](https://epsg.io/27700), which we need to apply manually.

```{r load-data}

# Read scotlip.gpkg layer, which includes data and geometry.

# Note: I have set the coordinate reference system (CRS) to NA because the CRS
#       supplied in the geopack (WGS 80) is incorrect.You can easily tell this 
#       by looking at he bounding box values. WGS 80 is a geographic coordinate
#       system with decimal degree units, so both the minima nor maxima values
#       are bounded by -180 to +180 degrees. The values here are all grater than
#       450,000, which indicate a projected coordinate system of easting and
#       northing in linear meters

src_sf <- sf::st_read(dsn = base::file.path(base::tempdir(), "scotlip.gpkg"),
                      layer = "scotlip",
                      crs = NA_crs_) # Remove the wrong coordinate reference system (CRS) assigned in the geopackage

# After some fossicking around, I was able to determine the correct projected coordinate
# system for these data is OSGB36 / British National Grid, which we now apply using
# the European Petroleum Survey Group (EPSG) code 27700 

sf::st_crs(src_sf) <- 27700 # see https://epsg.io/27700 for CRS details

# Check that the CRS has been applied to the spatial data 

print(src_sf)

```

### Enrich data

In this final preparation step, we wrangle the remaining attribute data into an intuitive analysis-ready format and enrich it by adding standardised incidence ratios and their exact Poisson 95% confidence intervals. We will also calculate indicies of estimate precision based on expected and observed lip cancer cases.

```{r enrich-data}

# Clean and enrich sf for data analysis

lip_sf <- src_sf %>%
  
  # Rename columns to lower case
  
  dplyr::rename_with(base::tolower) %>%
  
  # Limit to selected (renamed) variables
  
  dplyr::select(dist_code = district, dist_name = name, dist_popn = pop, obs_ca = cancer, exp_ca = cexp, pct_aff = aff) %>%
  
  # Correct typographical errors in district names

  
  dplyr::mutate(dplyr::across(dist_name, ~ dplyr::case_when(. == "EastKilbride" ~ "East Kilbride",
                                                            . == "EastLothian" ~ "East Lothian",
                                                            . == "NEFife" ~ "NE Fife",
                                                            . == "WesternIsles" ~ "Western Isles",
                                                            . == "WestLothian" ~ "West Lothian",
                                                            .default = .))) %>%
  
  # Calculate standardised incidence ratios (SIR) with exact Poisson 95% 
  # confidence intervals using using pois.exact function from epitools.
  
  dplyr::bind_cols(base::data.frame(epitools::pois.exact(pull(., obs_ca), pull(., exp_ca)) %>%
                                      dplyr::select(obs_sir_est = rate,
                                                    obs_sir_l95 = lower,
                                                    obs_sir_u95  = upper))) %>%
  
  # Calculate standard and relative errors for SIR
  
  dplyr::mutate(obs_sir_se = base::sqrt(obs_ca) / exp_ca,
                obs_sir_rse = obs_sir_se / obs_sir_est,   # Also estimated by RSE = 1 / base::sqrt(obs_ca),
                exp_sir_rse = 1 / exp_ca) %>%
  
  # Add district centroids (note use of sf::st_geometry - avoids warnings about assumed attribute distributions

  dplyr::bind_cols(sf::st_coordinates(sf::st_centroid(sf::st_geometry(.))) %>%
                     base::as.data.frame() %>%
                     dplyr::rename(centroid_x = X, centroid_y = Y)) %>%
  
  # Add variable labels
  
  labelled::set_variable_labels(dist_code = "District code",
                                dist_name = "District name",
                                dist_popn = "Male population years at risk (1975-1980)",
                                obs_ca = "Observed male lip cancer cases (1975-1980)",
                                exp_ca = "Expected male lip cancer cases (1975-1980)",
                                pct_aff = "Percent of male population working in agriculture, fishing or forestry",
                                obs_sir_est = "Observed SIR estimate",
                                obs_sir_l95 = "Observed SIR lower 95% CI",
                                obs_sir_u95 = "Observed SIR upper 95% CI",
                                obs_sir_se = "Observed SIR standard error",
                                obs_sir_rse = "Observed SIR relative standard error",
                                exp_sir_rse = "Proportional precision of SIR from expected cases",
                                centroid_x = "Centroid X coordinate (EPSG:27700)",
                                centroid_y = "Centroid Y coordinate (EPSG:27700)",
                                geom = "Geometry (OSGB 1936 / British National Grid)") %>%
  
  # Move geometry column to end of data set
  
  dplyr::select(dplyr::everything(), -geom, geom)

# View data set header

print(lip_sf %>% dplyr::select(-c(centroid_x, centroid_y, geom)), n = 100)

print(sf::st_drop_geometry(lip_sf), n = 100)

```


Having read the GeoPackage into `R` and fixed the coordinate reference system, we can take our first look at the spatial data

```{r moredata}



## Use gpk_sf layer to create a Scotland boundary layer ----------------------

sct_sf <- lip_sf %>%
  dplyr::mutate(area = "Scotland") %>%
  dplyr::summarise(geom = sf::st_union(geom),
                  .by = area)





sf::st_union(src_sf, by_feature = FALSE) %>%
  sf::st_as_sf() %>%
  dplyr::mutate(area = "Scotland") %>%
  dplyr::select(area, geom = x)

```


## References

<p class="nlm-reference">Clayton D, Kaldor J. Empirical Bayes estimates of age standardised relative risks for use in disease mapping. Biometrics 1987;43:671--681. doi: [10.2307/2532003](https://doi.org/10.2307/2532003)</p>

<p class="nlm-reference">Cressie NAC. Statistics for spatial data. New York: John Wiley & Sons; 1993. p. 537 (Table 7.2). doi: [10.1002/9781119115151](https://doi.org/10.1002/9781119115151)</p>

<p class="nlm-reference">Stern H, Cressie N. Inferences for extremes in disease mapping. In Lawson AB, Biggeri A, Böhning D, et al., editors. Disease mapping and risk assessment for public health. New York: Wiley; 1999. pp. 68--69 (Table 5.1). Available at Storage General ([614.42 41](https://sydney.primo.exlibrisgroup.com/permalink/61USYD_INST/1c0ug48/alma991006490639705106))</p>
